@page "/blog/workflow/{TaskId:int}"
@using BlogAgent.Domain.Domain.Dto
@using BlogAgent.Domain.Domain.Enum
@using BlogAgent.Domain.Services
@using BlogAgent.Domain.Services.Workflows
@inject BlogWorkflowService WorkflowService
@inject BlogAgentWorkflowService AgentWorkflowService
@inject BlogService BlogService
@inject NavigationManager Navigation
@inject IMessageService Message
@implements IDisposable

<PageHeader Title="åšå®¢ç”Ÿæˆå·¥ä½œæµ (åˆ†æ­¥æ¨¡å¼)">
    <PageHeaderBreadcrumb>
        <Breadcrumb>
            <BreadcrumbItem Href="/blog/list">åšå®¢ç®¡ç†</BreadcrumbItem>
            <BreadcrumbItem>å·¥ä½œæµæ‰§è¡Œ</BreadcrumbItem>
        </Breadcrumb>
    </PageHeaderBreadcrumb>
    <PageHeaderExtra>
        <Button OnClick="@(() => Navigation.NavigateTo($"/blog/auto-workflow/{TaskId}"))">
            <Icon Type="rocket" /> åˆ‡æ¢åˆ°å…¨è‡ªåŠ¨æ¨¡å¼
        </Button>
    </PageHeaderExtra>
</PageHeader>

<div style="padding:24px; border-radius: 12px; margin-bottom: 24px; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.25);">
    <Steps Current="@currentStep" Status="@stepStatus" Type="StepsType.Navigation" Size="StepsSize.Default" 
           Style="background: white; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <Step Title="èµ„æ–™æ”¶é›†" Description="ResearcherAgent åˆ†æ­¥æ‰§è¡Œ" Icon="file-search" />
        <Step Title="åšå®¢æ’°å†™" Description="WriterAgent åˆ†æ­¥æ‰§è¡Œ" Icon="edit" />
        <Step Title="è´¨é‡å®¡æŸ¥" Description="ReviewerAgent åˆ†æ­¥æ‰§è¡Œ" Icon="audit" />
        <Step Title="å®Œæˆ" Description="å·¥ä½œæµæ‰§è¡Œå®Œæ¯•" Icon="check-circle" />
    </Steps>
</div>

<Card Title="@currentStageTitle">
    @if (currentStage == "research")
    {
        <div>
            @if (researchResult == null && !stageExecuting)
            {
                <Result Status="ResultStatus.Info"
                        Title="å‡†å¤‡å¼€å§‹èµ„æ–™æ”¶é›†é˜¶æ®µ"
                        SubTitle="ResearcherAgent å°†æ”¶é›†å’Œæ•´ç†ä¸ä¸»é¢˜ç›¸å…³çš„èµ„æ–™">
                    <Extra>
                        <Button Type="@ButtonType.Primary" Size="@ButtonSize.Large" OnClick="@ExecuteResearchStage" Loading="@stageExecuting">
                            <Icon Type="play-circle" /> å¼€å§‹æ”¶é›†èµ„æ–™
                        </Button>
                    </Extra>
                </Result>
            }
            else if (stageExecuting)
            {
                <div style="text-align:center; padding: 40px 0;">
                    <Spin Size="SpinSize.Large" />
                    <p style="margin-top:30px; font-size:20px; font-weight:600; color:#7F7FFF;">æ­£åœ¨æ”¶é›†å’Œæ•´ç†èµ„æ–™...</p>
                    <p style="color:#999; margin-top:10px; font-size:14px;">
                        <Icon Type="clock-circle" /> ResearcherAgent æ­£åœ¨å·¥ä½œ,è¿™å¯èƒ½éœ€è¦30ç§’åˆ°1åˆ†é’Ÿ
                    </p>
                </div>
            }
            else if (researchResult != null)
            {
                <Result Status="ResultStatus.Success"
                        Title="âœ… èµ„æ–™æ”¶é›†å®Œæˆ!"
                        SubTitle="ResearcherAgent å·²å®Œæˆèµ„æ–™æ”¶é›†å’Œæ•´ç†">
                    <Extra>
                        <Space>
                            <SpaceItem>
                                <Button Type="@ButtonType.Primary" Size="@ButtonSize.Large" OnClick="@ProceedToWriteStage" Disabled="@editingResearch">
                                    <Icon Type="arrow-right" /> ç»§ç»­æ’°å†™
                                </Button>
                            </SpaceItem>
                            <SpaceItem>
                                <Button Size="@ButtonSize.Large" OnClick="@ToggleEditResearch">
                                    <Icon Type="@(editingResearch ? "save" : "edit")" /> @(editingResearch ? "ä¿å­˜ä¿®æ”¹" : "ç¼–è¾‘èµ„æ–™")
                                </Button>
                            </SpaceItem>
                            <SpaceItem>
                                <Button Size="@ButtonSize.Large" OnClick="@ExecuteResearchStage" Disabled="@editingResearch">
                                    <Icon Type="redo" /> é‡æ–°æ”¶é›†
                                </Button>
                            </SpaceItem>
                        </Space>
                    </Extra>
                </Result>

                <Divider />

                @if (editingResearch)
                {
                    <Card Title="ç¼–è¾‘èµ„æ–™æ‘˜è¦" Style="margin-top:20px;">
                        <TextArea @bind-Value="@researchSummaryEdit" 
                                  Rows="20" 
                                  Placeholder="ç¼–è¾‘èµ„æ–™æ‘˜è¦..." 
                                  Style="font-size: 14px; line-height: 1.8; width:100%;" />
                    </Card>
                }
                else
                {
                    <Card Title="ğŸ“ èµ„æ–™æ‘˜è¦" Style="margin-top:20px;">
                        <Markdown Value="@researchResult.Summary" />
                    </Card>
                }
            }
        </div>
    }
    else if (currentStage == "write")
    {
        <div>
            @if (draftContent == null && !stageExecuting)
            {
                <Result Status="ResultStatus.Info"
                        Title="å‡†å¤‡å¼€å§‹åšå®¢æ’°å†™é˜¶æ®µ"
                        SubTitle="WriterAgent å°†åŸºäºæ”¶é›†çš„èµ„æ–™æ’°å†™åšå®¢å†…å®¹">
                    <Extra>
                        <Button Type="@ButtonType.Primary" Size="@ButtonSize.Large" OnClick="@ExecuteWriteStage" Loading="@stageExecuting">
                            <Icon Type="play-circle" /> å¼€å§‹æ’°å†™åšå®¢
                        </Button>
                    </Extra>
                </Result>
            }
            else if (stageExecuting)
            {
                <div style="text-align:center; padding: 40px 0;">
                    <Spin Size="SpinSize.Large" />
                    <p style="margin-top:30px; font-size:20px; font-weight:600; color:#7F7FFF;">æ­£åœ¨æ’°å†™åšå®¢å†…å®¹...</p>
                    <p style="color:#999; margin-top:10px; font-size:14px;">
                        <Icon Type="clock-circle" /> WriterAgent æ­£åœ¨å·¥ä½œ,è¿™å¯èƒ½éœ€è¦1-2åˆ†é’Ÿ
                    </p>
                </div>
            }
            else if (draftContent != null)
            {
                <Result Status="ResultStatus.Success"
                        Title="âœ… åšå®¢æ’°å†™å®Œæˆ!"
                        SubTitle="WriterAgent å·²å®Œæˆåšå®¢å†…å®¹æ’°å†™">
                    <Extra>
                        <Space>
                            <SpaceItem>
                                <Button Type="@ButtonType.Primary" Size="@ButtonSize.Large" OnClick="@ProceedToReviewStage" Disabled="@editingDraft">
                                    <Icon Type="arrow-right" /> æäº¤å®¡æŸ¥
                                </Button>
                            </SpaceItem>
                            <SpaceItem>
                                <Button Size="@ButtonSize.Large" OnClick="@ToggleEditDraft">
                                    <Icon Type="@(editingDraft ? "save" : "edit")" /> @(editingDraft ? "ä¿å­˜ä¿®æ”¹" : "ç¼–è¾‘åšå®¢")
                                </Button>
                            </SpaceItem>
                            <SpaceItem>
                                <Button Size="@ButtonSize.Large" OnClick="@ExecuteWriteStage" Disabled="@editingDraft">
                                    <Icon Type="redo" /> é‡æ–°æ’°å†™
                                </Button>
                            </SpaceItem>
                        </Space>
                    </Extra>
                </Result>

                <Divider />

                @if (editingDraft)
                {
                    <Card Title="ç¼–è¾‘åšå®¢" Style="margin-top:20px;">
                        <div style="width:100%;">
                            <div style="margin-bottom: 24px;">
                                <div style="margin-bottom: 8px;"><strong>æ ‡é¢˜:</strong></div>
                                <Input @bind-Value="@draftTitleEdit" Placeholder="ç¼–è¾‘æ ‡é¢˜..." Size="@InputSize.Large" Style="width:100%;" />
                            </div>
                            <div style="margin-bottom: 24px;">
                                <div style="margin-bottom: 8px;"><strong>å†…å®¹:</strong></div>
                                <TextArea @bind-Value="@draftContentEdit" 
                                          Rows="25" 
                                          Placeholder="ç¼–è¾‘åšå®¢å†…å®¹..." 
                                          Style="font-size: 14px; line-height: 1.8; width:100%;" />
                            </div>
                        </div>
                    </Card>
                }
                else
                {
                    <Card Title="@draftContent.Title" Style="margin-top:20px;">
                        <Extra>
                            <Tag Color="TagColor.Blue"><Icon Type="file-text" /> å­—æ•°: @draftContent.WordCount</Tag>
                            <Tag Color="TagColor.Green"><Icon Type="clock-circle" /> @draftContent.GeneratedAt.ToString("yyyy-MM-dd HH:mm")</Tag>
                        </Extra>
                        <ChildContent>
                            <Markdown Value="@draftContent.Content" />
                        </ChildContent>
                    </Card>
                }
            }
        </div>
    }
    else if (currentStage == "review")
    {
        <div>
            @if (reviewResult == null && !stageExecuting)
            {
                <Result Status="ResultStatus.Info"
                        Title="å‡†å¤‡å¼€å§‹è´¨é‡å®¡æŸ¥é˜¶æ®µ"
                        SubTitle="ReviewerAgent å°†è¯„ä¼°åšå®¢å†…å®¹çš„è´¨é‡">
                    <Extra>
                        <Button Type="@ButtonType.Primary" Size="@ButtonSize.Large" OnClick="@ExecuteReviewStage" Loading="@stageExecuting">
                            <Icon Type="play-circle" /> å¼€å§‹è´¨é‡å®¡æŸ¥
                        </Button>
                    </Extra>
                </Result>
            }
            else if (stageExecuting)
            {
                <div style="text-align:center; padding: 40px 0;">
                    <Spin Size="SpinSize.Large" />
                    <p style="margin-top:30px; font-size:20px; font-weight:600; color:#7F7FFF;">æ­£åœ¨è¿›è¡Œè´¨é‡å®¡æŸ¥...</p>
                    <p style="color:#999; margin-top:10px; font-size:14px;">
                        <Icon Type="clock-circle" /> ReviewerAgent æ­£åœ¨å·¥ä½œ,è¿™å¯èƒ½éœ€è¦30ç§’åˆ°1åˆ†é’Ÿ
                    </p>
                </div>
            }
            else if (reviewResult != null)
            {
                <Result Status="@(reviewResult.OverallScore >= 80 ? ResultStatus.Success : ResultStatus.Warning)"
                        Title="@(reviewResult.OverallScore >= 80 ? "âœ… å®¡æŸ¥é€šè¿‡!" : "âš ï¸ å»ºè®®ä¿®æ”¹")"
                        SubTitle="@(reviewResult.OverallScore >= 80 ? "ReviewerAgent è¯„ä¼°ç»“æœè‰¯å¥½,å¯ä»¥å‘å¸ƒ" : "ReviewerAgent å»ºè®®ä¿®æ”¹åå†å‘å¸ƒ")">
                    <Extra>
                        <Space>
                            <SpaceItem>
                                <Button Type="@ButtonType.Primary" Size="@ButtonSize.Large" OnClick="@PublishBlog" Loading="@publishing" Disabled="@editingReview">
                                    <Icon Type="check-circle" /> ç¡®è®¤å‘å¸ƒ
                                </Button>
                            </SpaceItem>
                            <SpaceItem>
                                <Button Size="@ButtonSize.Large" OnClick="@ToggleEditReview">
                                    <Icon Type="@(editingReview ? "save" : "edit")" /> @(editingReview ? "ä¿å­˜ä¿®æ”¹" : "ç¼–è¾‘è¯„å®¡")
                                </Button>
                            </SpaceItem>
                            <SpaceItem>
                                <Button Size="@ButtonSize.Large" OnClick="@BackToWriteStage" Disabled="@editingReview">
                                    <Icon Type="left" /> è¿”å›ä¿®æ”¹
                                </Button>
                            </SpaceItem>
                            <SpaceItem>
                                <Button Size="@ButtonSize.Large" OnClick="@(() => Navigation.NavigateTo($"/blog/detail/{TaskId}"))">
                                    <Icon Type="eye" /> é¢„è§ˆè¯¦æƒ…
                                </Button>
                            </SpaceItem>
                        </Space>
                    </Extra>
                </Result>

                <Divider />

                @if (editingReview)
                {
                    <Card Title="ç¼–è¾‘å®¡æŸ¥ç»“æœ" Style="margin-top:20px;">
                        <div style="width:100%;">
                            <div style="margin-bottom: 24px;">
                                <div style="margin-bottom: 8px;"><strong>ç»¼åˆè¯„åˆ† (0-100):</strong></div>
                                <Slider @bind-Value="@reviewScoreEdit" Min="0" Max="100" Style="width:100%;" />
                                <div style="margin-top: 8px; font-size: 16px; color: #1890ff;">
                                    <strong>å½“å‰åˆ†æ•°: @reviewScoreEdit</strong>
                                </div>
                            </div>
                            <div style="margin-bottom: 24px;">
                                <div style="margin-bottom: 8px;"><strong>å®¡æŸ¥å»ºè®®:</strong></div>
                                <Input @bind-Value="@reviewRecommendationEdit" 
                                       Placeholder="é€šè¿‡ / éœ€ä¿®æ”¹ / ä¸é€šè¿‡" 
                                       Size="@InputSize.Large"
                                       Style="width:100%;" />
                            </div>
                            <div style="margin-bottom: 24px;">
                                <div style="margin-bottom: 8px;"><strong>æ€»ç»“:</strong></div>
                                <TextArea @bind-Value="@reviewSummaryEdit" 
                                          Rows="10" 
                                          Placeholder="ç¼–è¾‘å®¡æŸ¥æ€»ç»“..." 
                                          Style="font-size: 14px; line-height: 1.8; width:100%;" />
                            </div>
                        </div>
                    </Card>
                }
                else
                {
                    <Descriptions Title="è´¨é‡è¯„ä¼°æŠ¥å‘Š" Bordered Column="2" Style="margin-top:20px;">
                        <DescriptionsItem Title="ç»¼åˆè¯„åˆ†" Span="2">
                            <Progress Percent="@reviewResult.OverallScore"
                                      Status="@(reviewResult.OverallScore >= 80 ? ProgressStatus.Success : reviewResult.OverallScore >= 60 ? ProgressStatus.Normal : ProgressStatus.Exception)"
                                      StrokeWidth="20" />
                        </DescriptionsItem>
                        <DescriptionsItem Title="å‡†ç¡®æ€§">
                            <Tag Color="@(reviewResult.Accuracy.Score >= 32 ? "success" : "warning")">@reviewResult.Accuracy.Score / 40</Tag>
                            @if (reviewResult.Accuracy.Issues.Any())
                            {
                                <ul style="margin-top:10px; color:#ff4d4f;">
                                    @foreach (var issue in reviewResult.Accuracy.Issues)
                                    {
                                        <li>@issue</li>
                                    }
                                </ul>
                            }
                        </DescriptionsItem>
                        <DescriptionsItem Title="é€»è¾‘æ€§">
                            <Tag Color="@(reviewResult.Logic.Score >= 24 ? "success" : "warning")">@reviewResult.Logic.Score / 30</Tag>
                            @if (reviewResult.Logic.Issues.Any())
                            {
                                <ul style="margin-top:10px; color:#ff4d4f;">
                                    @foreach (var issue in reviewResult.Logic.Issues)
                                    {
                                        <li>@issue</li>
                                    }
                                </ul>
                            }
                        </DescriptionsItem>
                        <DescriptionsItem Title="åŸåˆ›æ€§">
                            <Tag Color="@(reviewResult.Originality.Score >= 16 ? "success" : "warning")">@reviewResult.Originality.Score / 20</Tag>
                            @if (reviewResult.Originality.Issues.Any())
                            {
                                <ul style="margin-top:10px; color:#ff4d4f;">
                                    @foreach (var issue in reviewResult.Originality.Issues)
                                    {
                                        <li>@issue</li>
                                    }
                                </ul>
                            }
                        </DescriptionsItem>
                        <DescriptionsItem Title="è§„èŒƒæ€§">
                            <Tag Color="@(reviewResult.Formatting.Score >= 8 ? "success" : "warning")">@reviewResult.Formatting.Score / 10</Tag>
                            @if (reviewResult.Formatting.Issues.Any())
                            {
                                <ul style="margin-top:10px; color:#ff4d4f;">
                                    @foreach (var issue in reviewResult.Formatting.Issues)
                                    {
                                        <li>@issue</li>
                                    }
                                </ul>
                            }
                        </DescriptionsItem>
                        <DescriptionsItem Title="å®¡æŸ¥å»ºè®®" Span="2">
                            <Tag Color="@(reviewResult.Recommendation == "é€šè¿‡" ? "success" : reviewResult.Recommendation == "éœ€ä¿®æ”¹" ? "warning" : "error")" Style="font-size:16px; padding:5px 15px;">
                                @reviewResult.Recommendation
                            </Tag>
                        </DescriptionsItem>
                        @if (!string.IsNullOrEmpty(reviewResult.Summary))
                        {
                            <DescriptionsItem Title="æ€»ç»“" Span="2">
                                @reviewResult.Summary
                            </DescriptionsItem>
                        }
                    </Descriptions>
                }
            }
        </div>
    }
    else if (currentStage == "completed")
    {
        <Result Status="ResultStatus.Success"
                Title="ğŸ‰ åšå®¢å‘å¸ƒæˆåŠŸ!"
                SubTitle="æ‚¨çš„åšå®¢å·²ç»ä¿å­˜åˆ°æ•°æ®åº“,å¯ä»¥æŸ¥çœ‹è¯¦æƒ…æˆ–ç»§ç»­åˆ›å»ºæ–°åšå®¢">
            <Extra>
                <Space>
                    <SpaceItem>
                        <Button Type="@ButtonType.Primary" OnClick="@(() => Navigation.NavigateTo($"/blog/detail/{TaskId}"))">
                            <Icon Type="eye" /> æŸ¥çœ‹åšå®¢è¯¦æƒ…
                        </Button>
                    </SpaceItem>
                    <SpaceItem>
                        <Button OnClick="@(() => Navigation.NavigateTo("/blog/list"))">
                            <Icon Type="unordered-list" /> åšå®¢åˆ—è¡¨
                        </Button>
                    </SpaceItem>
                    <SpaceItem>
                        <Button OnClick="@(() => Navigation.NavigateTo("/blog/create"))">
                            <Icon Type="plus" /> åˆ›å»ºæ–°åšå®¢
                        </Button>
                    </SpaceItem>
                </Space>
            </Extra>
        </Result>
    }
</Card>

@code {
    [Parameter] public int TaskId { get; set; }

    // ä½¿ç”¨æ–°çš„ Agent Framework Workflow
    private bool useAgentFrameworkWorkflow = true;

    private int currentStep = 0;
    private StepsStatus stepStatus = StepsStatus.Process;
    private string currentStage = "research";
    private string currentStageTitle = "èµ„æ–™æ”¶é›†";
    private bool stageExecuting = false;
    private bool publishing = false;

    private ResearchResultDto? researchResult;
    private DraftContentDto? draftContent;
    private ReviewResultDto? reviewResult;

    // ç¼–è¾‘çŠ¶æ€
    private bool editingResearch = false;
    private bool editingDraft = false;
    private bool editingReview = false;

    // ç¼–è¾‘å†…å®¹
    private string researchSummaryEdit = "";
    private string draftTitleEdit = "";
    private string draftContentEdit = "";
    private double reviewScoreEdit = 0;
    private string reviewRecommendationEdit = "";
    private string reviewSummaryEdit = "";

    // ç”¨äºè·Ÿè¸ªç»„ä»¶æ˜¯å¦å·²è¢«é”€æ¯
    private bool _disposed = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadWorkflowState();
    }

    private async Task LoadWorkflowState()
    {
        try
        {
            // æ ¹æ®é…ç½®é€‰æ‹©ä½¿ç”¨å“ªä¸ªæœåŠ¡
            var state = useAgentFrameworkWorkflow 
                ? await AgentWorkflowService.GetWorkflowStateAsync(TaskId)
                : await WorkflowService.GetWorkflowStateAsync(TaskId);

            // æ£€æŸ¥ç»„ä»¶æ˜¯å¦å·²è¢«é”€æ¯
            if (_disposed) return;

            // æ ¹æ®çŠ¶æ€å†³å®šå½“å‰é˜¶æ®µ
            if (state.IsPublished)
            {
                currentStage = "completed";
                currentStep = 3;
                currentStageTitle = "å‘å¸ƒå®Œæˆ";
            }
            else if (state.HasReviewResult)
            {
                currentStage = "review";
                currentStep = 2;
                currentStageTitle = "è´¨é‡å®¡æŸ¥";
                reviewResult = await BlogService.GetReviewResultAsync(TaskId);
            }
            else if (state.HasDraftContent)
            {
                currentStage = "write";
                currentStep = 1;
                currentStageTitle = "åšå®¢æ’°å†™";
                var content = await BlogService.GetContentAsync(TaskId);
                if (content != null)
                {
                    draftContent = new DraftContentDto
                    {
                        Title = content.Title,
                        Content = content.Content,
                        WordCount = content.WordCount,
                        GeneratedAt = content.CreatedAt
                    };
                }
            }
            else if (state.HasResearchResult)
            {
                currentStage = "research";
                currentStep = 0;
                currentStageTitle = "èµ„æ–™æ”¶é›†";
                var content = await BlogService.GetContentAsync(TaskId);
                if (content != null && !string.IsNullOrEmpty(content.ResearchSummary))
                {
                    researchResult = new ResearchResultDto
                    {
                        Summary = content.ResearchSummary,
                        KeyPoints = new List<string>(),
                        Timestamp = content.CreatedAt
                    };
                }
            }

            await SafeStateHasChangedAsync();
        }
        catch (Exception ex)
        {
            if (!_disposed)
            {
                await InvokeAsync(() => Message.Error($"åŠ è½½å·¥ä½œæµçŠ¶æ€å¤±è´¥: {ex.Message}"));
            }
        }
    }

    private async Task ExecuteResearchStage()
    {
        stageExecuting = true;
        await SafeStateHasChangedAsync();
        
        try
        {
            // æ ¹æ®é…ç½®é€‰æ‹©ä½¿ç”¨å“ªä¸ªæœåŠ¡
            var result = useAgentFrameworkWorkflow
                ? await AgentWorkflowService.ExecuteStageAsync(TaskId, "research")
                : await WorkflowService.ExecuteStageAsync(TaskId, "research");

            // æ£€æŸ¥ç»„ä»¶æ˜¯å¦å·²è¢«é”€æ¯
            if (_disposed) return;

            if (result.Success && result.Output is ResearchResultDto research)
            {
                researchResult = research;
                await InvokeAsync(() => Message.Success("èµ„æ–™æ”¶é›†å®Œæˆ!"));
            }
            else
            {
                await InvokeAsync(() => Message.Error($"èµ„æ–™æ”¶é›†å¤±è´¥: {result.Message}"));
            }
        }
        catch (Exception ex)
        {
            if (!_disposed)
            {
                await InvokeAsync(() => Message.Error($"æ‰§è¡Œå¤±è´¥: {ex.Message}"));
            }
        }
        finally
        {
            if (!_disposed)
            {
                stageExecuting = false;
                await SafeStateHasChangedAsync();
            }
        }
    }

    private async Task ProceedToWriteStage()
    {
        currentStage = "write";
        currentStep = 1;
        currentStageTitle = "åšå®¢æ’°å†™";
        await SafeStateHasChangedAsync();
    }

    private async Task ExecuteWriteStage()
    {
        stageExecuting = true;
        await SafeStateHasChangedAsync();
        
        try
        {
            // æ ¹æ®é…ç½®é€‰æ‹©ä½¿ç”¨å“ªä¸ªæœåŠ¡
            var result = useAgentFrameworkWorkflow
                ? await AgentWorkflowService.ExecuteStageAsync(TaskId, "write")
                : await WorkflowService.ExecuteStageAsync(TaskId, "write");

            // æ£€æŸ¥ç»„ä»¶æ˜¯å¦å·²è¢«é”€æ¯
            if (_disposed) return;

            if (result.Success && result.Output is DraftContentDto draft)
            {
                draftContent = draft;
                await InvokeAsync(() => Message.Success("åšå®¢æ’°å†™å®Œæˆ!"));
            }
            else
            {
                await InvokeAsync(() => Message.Error($"åšå®¢æ’°å†™å¤±è´¥: {result.Message}"));
            }
        }
        catch (Exception ex)
        {
            if (!_disposed)
            {
                await InvokeAsync(() => Message.Error($"æ‰§è¡Œå¤±è´¥: {ex.Message}"));
            }
        }
        finally
        {
            if (!_disposed)
            {
                stageExecuting = false;
                await SafeStateHasChangedAsync();
            }
        }
    }

    private async Task ProceedToReviewStage()
    {
        currentStage = "review";
        currentStep = 2;
        currentStageTitle = "è´¨é‡å®¡æŸ¥";
        await SafeStateHasChangedAsync();
    }

    private async Task ExecuteReviewStage()
    {
        stageExecuting = true;
        await SafeStateHasChangedAsync();
        
        try
        {
            // æ ¹æ®é…ç½®é€‰æ‹©ä½¿ç”¨å“ªä¸ªæœåŠ¡
            var result = useAgentFrameworkWorkflow
                ? await AgentWorkflowService.ExecuteStageAsync(TaskId, "review")
                : await WorkflowService.ExecuteStageAsync(TaskId, "review");

            // æ£€æŸ¥ç»„ä»¶æ˜¯å¦å·²è¢«é”€æ¯
            if (_disposed) return;

            if (result.Success && result.Output is ReviewResultDto review)
            {
                reviewResult = review;
                await InvokeAsync(() => Message.Success("è´¨é‡å®¡æŸ¥å®Œæˆ!"));
            }
            else
            {
                await InvokeAsync(() => Message.Error($"è´¨é‡å®¡æŸ¥å¤±è´¥: {result.Message}"));
            }
        }
        catch (Exception ex)
        {
            if (!_disposed)
            {
                await InvokeAsync(() => Message.Error($"æ‰§è¡Œå¤±è´¥: {ex.Message}"));
            }
        }
        finally
        {
            if (!_disposed)
            {
                stageExecuting = false;
                await SafeStateHasChangedAsync();
            }
        }
    }

    private async Task BackToWriteStage()
    {
        currentStage = "write";
        currentStep = 1;
        currentStageTitle = "åšå®¢æ’°å†™";
        await SafeStateHasChangedAsync();
    }

    private async Task PublishBlog()
    {
        publishing = true;
        await SafeStateHasChangedAsync();
        
        try
        {
            var success = await BlogService.PublishBlogAsync(TaskId);

            // æ£€æŸ¥ç»„ä»¶æ˜¯å¦å·²è¢«é”€æ¯
            if (_disposed) return;

            if (success)
            {
                await InvokeAsync(() => Message.Success("åšå®¢å‘å¸ƒæˆåŠŸ!"));
                currentStage = "completed";
                currentStep = 3;
                currentStageTitle = "å‘å¸ƒå®Œæˆ";
                stepStatus = StepsStatus.Finish;
                await SafeStateHasChangedAsync();
            }
            else
            {
                await InvokeAsync(() => Message.Error("åšå®¢å‘å¸ƒå¤±è´¥"));
            }
        }
        catch (Exception ex)
        {
            if (!_disposed)
            {
                await InvokeAsync(() => Message.Error($"å‘å¸ƒå¤±è´¥: {ex.Message}"));
            }
        }
        finally
        {
            if (!_disposed)
            {
                publishing = false;
                await SafeStateHasChangedAsync();
            }
        }
    }

    /// <summary>
    /// å®‰å…¨åœ°è°ƒç”¨ StateHasChanged,æ£€æŸ¥ç»„ä»¶æ˜¯å¦å·²è¢«é”€æ¯
    /// </summary>
    private async Task SafeStateHasChangedAsync()
    {
        if (!_disposed)
        {
            try
            {
                await InvokeAsync(StateHasChanged);
            }
            catch (ObjectDisposedException)
            {
                // ç»„ä»¶å·²è¢«é”€æ¯,å¿½ç•¥æ­¤å¼‚å¸¸
            }
        }
    }

    private async Task ToggleEditResearch()
    {
        if (editingResearch)
        {
            // ä¿å­˜ä¿®æ”¹
            try
            {
                if (researchResult != null)
                {
                    researchResult.Summary = researchSummaryEdit;
                    // ä¿å­˜åˆ°æ•°æ®åº“
                    await BlogService.UpdateResearchSummaryAsync(TaskId, researchSummaryEdit);
                    await InvokeAsync(() => Message.Success("èµ„æ–™æ‘˜è¦å·²ä¿å­˜!"));
                }
            }
            catch (Exception ex)
            {
                await InvokeAsync(() => Message.Error($"ä¿å­˜å¤±è´¥: {ex.Message}"));
            }
        }
        else
        {
            // è¿›å…¥ç¼–è¾‘æ¨¡å¼
            researchSummaryEdit = researchResult?.Summary ?? "";
        }
        
        editingResearch = !editingResearch;
        await SafeStateHasChangedAsync();
    }

    private async Task ToggleEditDraft()
    {
        if (editingDraft)
        {
            // ä¿å­˜ä¿®æ”¹
            try
            {
                if (draftContent != null)
                {
                    draftContent.Title = draftTitleEdit;
                    draftContent.Content = draftContentEdit;
                    draftContent.WordCount = draftContentEdit.Length;
                    
                    // ä¿å­˜åˆ°æ•°æ®åº“
                    await BlogService.UpdateBlogContentAsync(TaskId, draftTitleEdit, draftContentEdit);
                    await InvokeAsync(() => Message.Success("åšå®¢å†…å®¹å·²ä¿å­˜!"));
                }
            }
            catch (Exception ex)
            {
                await InvokeAsync(() => Message.Error($"ä¿å­˜å¤±è´¥: {ex.Message}"));
            }
        }
        else
        {
            // è¿›å…¥ç¼–è¾‘æ¨¡å¼
            draftTitleEdit = draftContent?.Title ?? "";
            draftContentEdit = draftContent?.Content ?? "";
        }
        
        editingDraft = !editingDraft;
        await SafeStateHasChangedAsync();
    }

    private async Task ToggleEditReview()
    {
        if (editingReview)
        {
            // ä¿å­˜ä¿®æ”¹
            try
            {
                if (reviewResult != null)
                {
                    reviewResult.OverallScore = (int)reviewScoreEdit;
                    reviewResult.Recommendation = reviewRecommendationEdit;
                    reviewResult.Summary = reviewSummaryEdit;
                    
                    // ä¿å­˜åˆ°æ•°æ®åº“
                    await BlogService.UpdateReviewResultAsync(TaskId, (int)reviewScoreEdit, reviewRecommendationEdit, reviewSummaryEdit);
                    await InvokeAsync(() => Message.Success("å®¡æŸ¥ç»“æœå·²ä¿å­˜!"));
                }
            }
            catch (Exception ex)
            {
                await InvokeAsync(() => Message.Error($"ä¿å­˜å¤±è´¥: {ex.Message}"));
            }
        }
        else
        {
            // è¿›å…¥ç¼–è¾‘æ¨¡å¼
            reviewScoreEdit = reviewResult?.OverallScore ?? 0;
            reviewRecommendationEdit = reviewResult?.Recommendation ?? "";
            reviewSummaryEdit = reviewResult?.Summary ?? "";
        }
        
        editingReview = !editingReview;
        await SafeStateHasChangedAsync();
    }

    /// <summary>
    /// å®ç° IDisposable æ¥å£
    /// </summary>
    public void Dispose()
    {
        _disposed = true;
    }
}

