@page "/blog/auto-workflow/{TaskId:int}"
@using BlogAgent.Domain.Domain.Dto
@using BlogAgent.Domain.Services
@using BlogAgent.Domain.Services.Workflows
@inject BlogAgentWorkflowService AgentWorkflowService
@inject BlogService BlogService
@inject NavigationManager Navigation
@inject IMessageService Message
@implements IDisposable

<PageHeader Title="Êô∫ËÉΩÂçöÂÆ¢ÁîüÊàêÂ∑•‰ΩúÊµÅ (Agent Framework)">
    <PageHeaderBreadcrumb>
        <Breadcrumb>
            <BreadcrumbItem Href="/blog/list">ÂçöÂÆ¢ÁÆ°ÁêÜ</BreadcrumbItem>
            <BreadcrumbItem>Ëá™Âä®ÂåñÂ∑•‰ΩúÊµÅ</BreadcrumbItem>
        </Breadcrumb>
    </PageHeaderBreadcrumb>
    <PageHeaderContent>
        <Alert Type="@AlertType.Info" Message="‰ΩøÁî® Microsoft Agent Framework Workflow Ëá™Âä®ÁºñÊéíÂçöÂÆ¢ÁîüÊàêÊµÅÁ®ã" ShowIcon="true" />
    </PageHeaderContent>
    <PageHeaderExtra>
        <Button OnClick="@(() => Navigation.NavigateTo($"/blog/workflow/{TaskId}"))">
            <Icon Type="edit" /> ÂàáÊç¢Âà∞ÂàÜÊ≠•Ê®°Âºè
        </Button>
    </PageHeaderExtra>
</PageHeader>

<div style="padding:24px; border-radius: 12px; margin-bottom: 24px; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.25);">
    <Steps Current="@currentStep" Status="@stepStatus" Type="StepsType.Navigation" Size="StepsSize.Default" 
           Style="background: white; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <Step Title="ËµÑÊñôÊî∂ÈõÜ" Description="ResearcherAgent Ëá™Âä®ÊâßË°å" Icon="file-search" />
        <Step Title="ÂçöÂÆ¢Êí∞ÂÜô" Description="WriterAgent Ëá™Âä®ÊâßË°å" Icon="edit" />
        <Step Title="Ë¥®ÈáèÂÆ°Êü•" Description="ReviewerAgent Ëá™Âä®ÊâßË°å" Icon="audit" />
        <Step Title="ÂÆåÊàê" Description="Â∑•‰ΩúÊµÅÊâßË°åÂÆåÊØï" Icon="check-circle" />
    </Steps>
</div>

<Card Title="@currentStageTitle">
    @if (!workflowStarted && !workflowCompleted)
    {
        <Result Status="ResultStatus.Info"
                Title="ÂáÜÂ§áÂêØÂä®Êô∫ËÉΩÂçöÂÆ¢ÁîüÊàêÂ∑•‰ΩúÊµÅ"
                SubTitle="ÁÇπÂáª‰∏ãÊñπÊåâÈíÆ,Á≥ªÁªüÂ∞ÜËá™Âä®ÊâßË°åËµÑÊñôÊî∂ÈõÜ„ÄÅÂçöÂÆ¢Êí∞ÂÜôÂíåË¥®ÈáèÂÆ°Êü•‰∏â‰∏™Èò∂ÊÆµ">
            <Extra>
                <Button Type="@ButtonType.Primary" Size="@ButtonSize.Large" OnClick="@StartWorkflow" Loading="@workflowExecuting">
                    <Icon Type="rocket" /> ÂêØÂä®Â∑•‰ΩúÊµÅ
                </Button>
            </Extra>
        </Result>
    }
    else if (workflowExecuting)
    {
        <div style="text-align:center; padding: 40px 0;">
            <Spin Size="SpinSize.Large" />
            <p style="margin-top:30px; font-size:20px; font-weight:600; color:#7F7FFF;">@executionMessage</p>
            <p style="color:#999; margin-top:10px; font-size:14px;">
                <Icon Type="clock-circle" /> Â∑•‰ΩúÊµÅÊ≠£Âú®Ëá™Âä®ËøêË°å,ÂêÑ‰∏™ Agent ‰æùÊ¨°ÊâßË°å... (ËΩÆËØ¢Ê¨°Êï∞: @_pollingCount)
            </p>
            
            <!-- ÂßãÁªàÊòæÁ§∫ËøõÂ∫¶Âç°Áâá,Âç≥‰Ωø currentAgentOutput ‰∏∫Á©∫ -->
            <Card Title="@($"{GetCurrentAgentIcon()} ÊâßË°åËøõÂ∫¶")" Size="CardSize.Small" 
                  Style="margin-top:30px; text-align:left; max-width:900px; margin-left:auto; margin-right:auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                
                <div style="padding: 20px; border-radius: 8px; color: white; margin-bottom: 20px;">
                    <h3 style="margin: 0; font-size: 18px; display: flex; align-items: center; gap: 10px;">
                        @if (currentStep == 0)
                        {
                            <Icon Type="file-search" Style="font-size: 24px;" />
                            <span>ResearcherAgent Ê≠£Âú®Â∑•‰Ωú</span>
                        }
                        else if (currentStep == 1)
                        {
                            <Icon Type="edit" Style="font-size: 24px;" />
                            <span>WriterAgent Ê≠£Âú®Â∑•‰Ωú</span>
                        }
                        else if (currentStep == 2)
                        {
                            <Icon Type="audit" Style="font-size: 24px;" />
                            <span>ReviewerAgent Ê≠£Âú®Â∑•‰Ωú</span>
                        }
                        else
                        {
                            <Icon Type="loading" Style="font-size: 24px;" />
                            <span>ÂáÜÂ§á‰∏≠...</span>
                        }
                    </h3>
                </div>
                
                <div style="background: #f6f8fa; padding: 20px; border-radius: 8px; font-family: 'Consolas', 'Monaco', monospace; white-space: pre-wrap; line-height: 1.8; color: #24292e; font-size: 14px; border-left: 4px solid #667eea;">
                    @if (!string.IsNullOrEmpty(currentAgentOutput))
                    {
                        @currentAgentOutput
                    }
                    else
                    {
                        <text>‚è≥ Ê≠£Âú®Á≠âÂæÖ Agent ÂìçÂ∫î...</text>
                    }
                </div>
                
                <Timeline Style="margin-top: 20px;">
                    <TimelineItem Color="@(currentStep >= 0 ? "green" : "gray")">
                        <Icon Type="file-search" /> ËµÑÊñôÊî∂ÈõÜÈò∂ÊÆµ @(currentStep > 0 ? "‚úì" : "‚óè")
                        @if (currentStep == 0)
                        {
                            <Tag Color="@("blue")" Style="margin-left: 10px;">ËøõË°å‰∏≠</Tag>
                        }
                    </TimelineItem>
                    <TimelineItem Color="@(currentStep >= 1 ? "green" : currentStep == 0 ? "blue" : "gray")">
                        <Icon Type="edit" /> ÂçöÂÆ¢Êí∞ÂÜôÈò∂ÊÆµ @(currentStep > 1 ? "‚úì" : currentStep == 1 ? "‚óè" : "")
                        @if (currentStep == 1)
                        {
                            <Tag Color="@("blue")" Style="margin-left: 10px;">ËøõË°å‰∏≠</Tag>
                        }
                    </TimelineItem>
                    <TimelineItem Color="@(currentStep >= 2 ? "green" : currentStep == 1 ? "blue" : "gray")">
                        <Icon Type="audit" /> Ë¥®ÈáèÂÆ°Êü•Èò∂ÊÆµ @(currentStep > 2 ? "‚úì" : currentStep == 2 ? "‚óè" : "")
                        @if (currentStep == 2)
                        {
                            <Tag Color="@("blue")" Style="margin-left: 10px;">ËøõË°å‰∏≠</Tag>
                        }
                    </TimelineItem>
                    <TimelineItem Color="@(currentStep >= 3 ? "green" : "gray")">
                        <Icon Type="check-circle" /> ÂÆåÊàê @(currentStep >= 3 ? "‚úì" : "")
                    </TimelineItem>
                </Timeline>
            </Card>
        </div>
    }
    else if (workflowCompleted)
    {
        <Result Status="@(workflowSuccess ? ResultStatus.Success : ResultStatus.Error)"
                Title="@(workflowSuccess ? "üéâ ÂçöÂÆ¢ÁîüÊàêÂ∑•‰ΩúÊµÅÊâßË°åÊàêÂäü!" : "‚ùå Â∑•‰ΩúÊµÅÊâßË°åÂ§±Ë¥•")"
                SubTitle="@resultMessage">
            <Extra>
                @if (workflowSuccess)
                {
                    <Space>
                        <SpaceItem>
                            <Button Type="@ButtonType.Primary" OnClick="@(() => Navigation.NavigateTo($"/blog/detail/{TaskId}"))">
                                <Icon Type="eye" /> Êü•ÁúãÂçöÂÆ¢ËØ¶ÊÉÖ
                            </Button>
                        </SpaceItem>
                        <SpaceItem>
                            <Button OnClick="@(() => Navigation.NavigateTo("/blog/list"))">
                                <Icon Type="unordered-list" /> ÂçöÂÆ¢ÂàóË°®
                            </Button>
                        </SpaceItem>
                        <SpaceItem>
                            <Button OnClick="@(() => Navigation.NavigateTo("/blog/create"))">
                                <Icon Type="plus" /> ÂàõÂª∫Êñ∞ÂçöÂÆ¢
                            </Button>
                        </SpaceItem>
                    </Space>
                }
                else
                {
                    <Space>
                        <SpaceItem>
                            <Button Type="@ButtonType.Primary" OnClick="@StartWorkflow">
                                <Icon Type="redo" /> ÈáçÊñ∞ÊâßË°å
                            </Button>
                        </SpaceItem>
                        <SpaceItem>
                            <Button OnClick="@(() => Navigation.NavigateTo($"/blog/workflow/{TaskId}"))">
                                <Icon Type="edit" /> ÂàÜÊ≠•Ë∞ÉËØï
                            </Button>
                        </SpaceItem>
                    </Space>
                }
            </Extra>
        </Result>

        @if (workflowSuccess && reviewResult != null)
        {
            <Divider />
            
            <Descriptions Title="Ë¥®ÈáèËØÑ‰º∞Êä•Âëä" Bordered Column="2" Style="margin-top:20px;">
                <DescriptionsItem Title="ÁªºÂêàËØÑÂàÜ" Span="2">
                    <Progress Percent="@reviewResult.OverallScore"
                              Status="@(reviewResult.OverallScore >= 80 ? ProgressStatus.Success : reviewResult.OverallScore >= 60 ? ProgressStatus.Normal : ProgressStatus.Exception)"
                              StrokeWidth="20" />
                </DescriptionsItem>
                <DescriptionsItem Title="ÂáÜÁ°ÆÊÄß">
                    <Tag Color="@(reviewResult.Accuracy.Score >= 32 ? "success" : "warning")">@reviewResult.Accuracy.Score / 40</Tag>
                </DescriptionsItem>
                <DescriptionsItem Title="ÈÄªËæëÊÄß">
                    <Tag Color="@(reviewResult.Logic.Score >= 24 ? "success" : "warning")">@reviewResult.Logic.Score / 30</Tag>
                </DescriptionsItem>
                <DescriptionsItem Title="ÂéüÂàõÊÄß">
                    <Tag Color="@(reviewResult.Originality.Score >= 16 ? "success" : "warning")">@reviewResult.Originality.Score / 20</Tag>
                </DescriptionsItem>
                <DescriptionsItem Title="ËßÑËåÉÊÄß">
                    <Tag Color="@(reviewResult.Formatting.Score >= 8 ? "success" : "warning")">@reviewResult.Formatting.Score / 10</Tag>
                </DescriptionsItem>
                <DescriptionsItem Title="ÂÆ°Êü•Âª∫ËÆÆ" Span="2">
                    <Tag Color="@(reviewResult.Recommendation == "ÈÄöËøá" ? "success" : reviewResult.Recommendation == "ÈúÄ‰øÆÊîπ" ? "warning" : "error")" Style="font-size:16px; padding:5px 15px;">
                        @reviewResult.Recommendation
                    </Tag>
                </DescriptionsItem>
            </Descriptions>
        }
    }
</Card>

@code {
    [Parameter] public int TaskId { get; set; }

    private int currentStep = 0;
    private StepsStatus stepStatus = StepsStatus.Process;
    private string currentStageTitle = "Êô∫ËÉΩÂçöÂÆ¢ÁîüÊàêÂ∑•‰ΩúÊµÅ";
    
    private bool workflowStarted = false;
    private bool workflowExecuting = false;
    private bool workflowCompleted = false;
    private bool workflowSuccess = false;
    
    private string executionMessage = "";
    private string resultMessage = "";
    private string currentAgentOutput = "";
    
    private ReviewResultDto? reviewResult;
    private bool _disposed = false;
    
    private System.Threading.Timer? _progressTimer;
    private int _pollingCount = 0;

    protected override async Task OnInitializedAsync()
    {
        // Ê£ÄÊü•Â∑•‰ΩúÊµÅÁä∂ÊÄÅ
        try
        {
            var state = await AgentWorkflowService.GetWorkflowStateAsync(TaskId);
            
            if (state.IsPublished || state.HasReviewResult)
            {
                workflowCompleted = true;
                workflowSuccess = true;
                currentStep = 3;
                stepStatus = StepsStatus.Finish;
                resultMessage = "Â∑•‰ΩúÊµÅÂ∑≤ÂÆåÊàê,ÂçöÂÆ¢ÁîüÊàêÊàêÂäü!";
                
                if (state.HasReviewResult)
                {
                    reviewResult = await BlogService.GetReviewResultAsync(TaskId);
                }
            }
        }
        catch (Exception ex)
        {
            await InvokeAsync(() => Message.Warning($"Êó†Ê≥ïÂä†ËΩΩÂ∑•‰ΩúÊµÅÁä∂ÊÄÅ: {ex.Message}"));
        }
    }

    private async Task StartWorkflow()
    {
        workflowStarted = true;
        workflowExecuting = true;
        workflowCompleted = false;
        currentStep = 0;
        executionMessage = "Ê≠£Âú®ÂêØÂä®Â∑•‰ΩúÊµÅ...";
        _pollingCount = 0;
        await SafeStateHasChangedAsync();

        try
        {
            // ÂêØÂä®ËøõÂ∫¶ËΩÆËØ¢ (ÊØè 1 ÁßíÊü•ËØ¢‰∏ÄÊ¨°ÔºåÊõ¥ÂÆûÊó∂)
            _progressTimer = new System.Threading.Timer(async _ => await PollProgress(), null, 500, 1000);
            
            // Âú®ÂêéÂè∞ÊâßË°åÂ∑•‰ΩúÊµÅ
            _ = Task.Run(async () =>
            {
                try
                {
                    var result = await AgentWorkflowService.ExecuteFullWorkflowAsync(TaskId);
                    
                    if (!_disposed)
                    {
                        // Á≠âÂæÖÊúÄÂêé‰∏ÄÊ¨°ËΩÆËØ¢ÂÆåÊàê
                        await Task.Delay(500);
                        
                        // ÂÅúÊ≠¢ËΩÆËØ¢
                        _progressTimer?.Dispose();
                        _progressTimer = null;
                    }
                }
                catch (Exception ex)
                {
                    if (!_disposed)
                    {
                        _progressTimer?.Dispose();
                        _progressTimer = null;
                        
                        workflowSuccess = false;
                        stepStatus = StepsStatus.Error;
                        resultMessage = $"ÊâßË°åÂºÇÂ∏∏: {ex.Message}";
                        workflowExecuting = false;
                        workflowCompleted = true;
                        
                        await InvokeAsync(() =>
                        {
                            Message.Error($"ÊâßË°åÂ§±Ë¥•: {ex.Message}");
                            StateHasChanged();
                        });
                    }
                }
            });
        }
        catch (Exception ex)
        {
            if (!_disposed)
            {
                workflowSuccess = false;
                stepStatus = StepsStatus.Error;
                resultMessage = $"ÂêØÂä®Â§±Ë¥•: {ex.Message}";
                workflowExecuting = false;
                workflowCompleted = true;
                
                await InvokeAsync(() => Message.Error($"ÂêØÂä®Â§±Ë¥•: {ex.Message}"));
                await SafeStateHasChangedAsync();
            }
        }
    }

    private async Task PollProgress()
    {
        if (_disposed || !workflowExecuting) return;

        try
        {
            _pollingCount++;
            
            // Ëé∑ÂèñÊúÄÊñ∞ËøõÂ∫¶
            var progress = AgentWorkflowService.GetWorkflowProgress(TaskId);
            
            // Ë∞ÉËØï‰ø°ÊÅØ
            Console.WriteLine($"[PollProgress] ËΩÆËØ¢Ê¨°Êï∞: {_pollingCount}, ËøõÂ∫¶ÂØπË±°: {(progress != null ? "Â≠òÂú®" : "null")}");
            
            if (progress != null)
            {
                Console.WriteLine($"[PollProgress] CurrentStep: {progress.CurrentStep}, Message: {progress.Message}, Output: {progress.CurrentOutput?.Substring(0, Math.Min(50, progress.CurrentOutput?.Length ?? 0))}");
                
                await InvokeAsync(() =>
                {
                    currentStep = progress.CurrentStep;
                    executionMessage = progress.Message;
                    currentAgentOutput = progress.CurrentOutput ?? "";
                    
                    Console.WriteLine($"[UIÊõ¥Êñ∞] currentStep: {currentStep}, executionMessage: {executionMessage}");
                    
                    // Êõ¥Êñ∞Ê≠•È™§Áä∂ÊÄÅ
                    if (progress.Status == "failed")
                    {
                        stepStatus = StepsStatus.Error;
                    }
                    else if (progress.IsCompleted)
                    {
                        stepStatus = StepsStatus.Finish;
                    }
                    else
                    {
                        stepStatus = StepsStatus.Process;
                    }
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÂÆåÊàê
                    if (progress.IsCompleted)
                    {
                        workflowExecuting = false;
                        workflowCompleted = true;
                        workflowSuccess = progress.IsSuccess;
                        
                        if (progress.IsSuccess)
                        {
                            resultMessage = "ÊâÄÊúâÈò∂ÊÆµÂ∑≤ÂÆåÊàê,ÂçöÂÆ¢ÁîüÊàêÊàêÂäü!";
                            reviewResult = progress.ReviewResult;
                             Message.Success("üéâ ÂçöÂÆ¢ÁîüÊàêÂ∑•‰ΩúÊµÅÊâßË°åÊàêÂäü!");
                        }
                        else
                        {
                            resultMessage = $"Â∑•‰ΩúÊµÅÊâßË°åÂ§±Ë¥•: {progress.ErrorMessage}";
                             Message.Error($"Â∑•‰ΩúÊµÅÊâßË°åÂ§±Ë¥•: {progress.ErrorMessage}");
                        }
                        
                        // ÂÅúÊ≠¢ËΩÆËØ¢
                        _progressTimer?.Dispose();
                        _progressTimer = null;
                    }
                    
                    StateHasChanged();
                });
            }
            else
            {
                Console.WriteLine($"[PollProgress] ËøõÂ∫¶ÂØπË±°‰∏∫ null, ËΩÆËØ¢Ê¨°Êï∞: {_pollingCount}");
                
                if (_pollingCount > 300) // 5ÂàÜÈíüË∂ÖÊó∂ (300 * 1Áßí)
                {
                    await InvokeAsync(() =>
                    {
                        workflowExecuting = false;
                        workflowCompleted = true;
                        workflowSuccess = false;
                        resultMessage = "Â∑•‰ΩúÊµÅÊâßË°åË∂ÖÊó∂";
                        stepStatus = StepsStatus.Error;
                        
                        _progressTimer?.Dispose();
                        _progressTimer = null;
                        
                         Message.Error("Â∑•‰ΩúÊµÅÊâßË°åË∂ÖÊó∂");
                        StateHasChanged();
                    });
                }
            }
        }
        catch (Exception ex)
        {
            // ËΩÆËØ¢Âá∫Èîô‰∏ç‰∏≠Êñ≠Êï¥‰∏™ÊµÅÁ®ã
            Console.WriteLine($"ËΩÆËØ¢ËøõÂ∫¶Âá∫Èîô: {ex.Message}");
        }
    }

    private async Task SafeStateHasChangedAsync()
    {
        if (!_disposed)
        {
            try
            {
                await InvokeAsync(StateHasChanged);
            }
            catch (ObjectDisposedException)
            {
                // ÁªÑ‰ª∂Â∑≤Ë¢´ÈîÄÊØÅ,ÂøΩÁï•
            }
        }
    }

    private string GetCurrentAgentIcon()
    {
        return currentStep switch
        {
            0 => "üîç ResearcherAgent",
            1 => "‚úçÔ∏è WriterAgent",
            2 => "üîé ReviewerAgent",
            _ => "‚úÖ"
        };
    }

    public void Dispose()
    {
        _disposed = true;
        _progressTimer?.Dispose();
        _progressTimer = null;
    }
}
