@page "/blog/auto-workflow/{TaskId:int}"
@using BlogAgent.Domain.Domain.Dto
@using BlogAgent.Domain.Services
@using BlogAgent.Domain.Services.Workflows
@inject BlogAgentWorkflowService AgentWorkflowService
@inject BlogAgentWorkflowServiceV2 AgentWorkflowServiceV2
@inject BlogService BlogService
@inject NavigationManager Navigation
@inject IMessageService Message
@implements IDisposable

<PageHeader Title="æ™ºèƒ½åšå®¢ç”Ÿæˆå·¥ä½œæµ (Agent Framework)">
    <PageHeaderBreadcrumb>
        <Breadcrumb>
            <BreadcrumbItem Href="/blog/list">åšå®¢ç®¡ç†</BreadcrumbItem>
            <BreadcrumbItem>è‡ªåŠ¨åŒ–å·¥ä½œæµ</BreadcrumbItem>
        </Breadcrumb>
    </PageHeaderBreadcrumb>
    <PageHeaderContent>
        <Alert Type="@AlertType.Info" Message="ä½¿ç”¨ Microsoft Agent Framework Workflow è‡ªåŠ¨ç¼–æ’åšå®¢ç”Ÿæˆæµç¨‹" ShowIcon="true" />
    </PageHeaderContent>
    <PageHeaderExtra>
        <Button OnClick="@(() => Navigation.NavigateTo($"/blog/workflow/{TaskId}"))">
            <Icon Type="edit" /> åˆ‡æ¢åˆ°åˆ†æ­¥æ¨¡å¼
        </Button>
    </PageHeaderExtra>
</PageHeader>

<!-- å·¥ä½œæµç‰ˆæœ¬é€‰æ‹©å™¨ -->
<div style="margin-bottom: 24px;">
    <Card Title="å·¥ä½œæµæ¨¡å¼" Size="CardSize.Small">
        <Body>
            <RadioGroup @bind-Value="@workflowVersion" Disabled="@workflowStarted">
                <Radio Style="@GetRadioStyle(true)" Value="@("V1")">
                    <strong>V1 é¡ºåºå·¥ä½œæµ</strong>
                    <br />
                    <span style="color: #666; font-size: 12px;">å›ºå®šæµç¨‹ï¼šç ”ç©¶ â†’ æ’°å†™ â†’ å®¡æŸ¥ï¼Œä¸€æ¬¡æ€§å®Œæˆ</span>
                </Radio>
                <Radio Style="@GetRadioStyle(false)" Value="@("V2")">
                    <strong>V2 æ¡ä»¶å·¥ä½œæµ (æ¨è)</strong>
                    <br />
                    <span style="color: #666; font-size: 12px;">æ™ºèƒ½æµç¨‹ï¼šè¯„åˆ†ä¸è¶³è‡ªåŠ¨é‡å†™ï¼Œè´¨é‡æ›´é«˜</span>
                </Radio>
            </RadioGroup>
        </Body>
    </Card>
</div>

<div style="padding:24px; border-radius: 12px; margin-bottom: 24px; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.25);">
    <Steps Current="@currentStep" Status="@stepStatus" Type="StepsType.Navigation" Size="StepsSize.Default"
           Style="background: white; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <Step Title="èµ„æ–™æ”¶é›†" Description="ResearcherAgent è‡ªåŠ¨æ‰§è¡Œ" Icon="file-search" />
        <Step Title="åšå®¢æ’°å†™" Description="WriterAgent è‡ªåŠ¨æ‰§è¡Œ" Icon="edit" />
        <Step Title="è´¨é‡å®¡æŸ¥" Description="ReviewerAgent è‡ªåŠ¨æ‰§è¡Œ" Icon="audit" />
        @if (workflowVersion == "V2")
        {
            <Step Title="æ™ºèƒ½é‡å†™" Description="è‡ªåŠ¨é‡å†™ä¼˜åŒ–å†…å®¹" Icon="sync" />
        }
        <Step Title="å®Œæˆ" Description="å·¥ä½œæµæ‰§è¡Œå®Œæ¯•" Icon="check-circle" />
    </Steps>
</div>

<Card Title="@currentStageTitle">
    @if (!workflowStarted && !workflowCompleted)
    {
        <Result Status="ResultStatus.Info"
                Title="å‡†å¤‡å¯åŠ¨æ™ºèƒ½åšå®¢ç”Ÿæˆå·¥ä½œæµ"
                SubTitle="ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®,ç³»ç»Ÿå°†è‡ªåŠ¨æ‰§è¡Œèµ„æ–™æ”¶é›†ã€åšå®¢æ’°å†™å’Œè´¨é‡å®¡æŸ¥ä¸‰ä¸ªé˜¶æ®µ">
            <Extra>
                <Button Type="@ButtonType.Primary" Size="@ButtonSize.Large" OnClick="@StartWorkflow" Loading="@workflowExecuting">
                    <Icon Type="rocket" /> å¯åŠ¨å·¥ä½œæµ
                </Button>
            </Extra>
        </Result>
    }
    else if (workflowExecuting)
    {
        <div style="text-align:center; padding: 40px 0;">
            <Spin Size="SpinSize.Large" />
            <p style="margin-top:30px; font-size:20px; font-weight:600; color:#7F7FFF;">@executionMessage</p>
            <p style="color:#999; margin-top:10px; font-size:14px;">
                <Icon Type="clock-circle" /> å·¥ä½œæµæ­£åœ¨è‡ªåŠ¨è¿è¡Œ,å„ä¸ª Agent ä¾æ¬¡æ‰§è¡Œ... (è½®è¯¢æ¬¡æ•°: @_pollingCount)
            </p>
            
            <!-- å§‹ç»ˆæ˜¾ç¤ºè¿›åº¦å¡ç‰‡,å³ä½¿ currentAgentOutput ä¸ºç©º -->
            <Card Title="@($"{GetCurrentAgentIcon()} æ‰§è¡Œè¿›åº¦")" Size="CardSize.Small" 
                  Style="margin-top:30px; text-align:left; max-width:900px; margin-left:auto; margin-right:auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                
                <div style="padding: 20px; border-radius: 8px; color: white; margin-bottom: 20px;">
                    <h3 style="margin: 0; font-size: 18px; display: flex; align-items: center; gap: 10px;">
                        @if (currentStep == 0)
                        {
                            <Icon Type="file-search" Style="font-size: 24px;" />
                            <span>ResearcherAgent æ­£åœ¨å·¥ä½œ</span>
                        }
                        else if (currentStep == 1)
                        {
                            <Icon Type="edit" Style="font-size: 24px;" />
                            <span>WriterAgent æ­£åœ¨å·¥ä½œ</span>
                        }
                        else if (currentStep == 2)
                        {
                            <Icon Type="audit" Style="font-size: 24px;" />
                            <span>ReviewerAgent æ­£åœ¨å·¥ä½œ</span>
                        }
                        else
                        {
                            <Icon Type="loading" Style="font-size: 24px;" />
                            <span>å‡†å¤‡ä¸­...</span>
                        }
                    </h3>
                </div>
                
                <div style="background: #f6f8fa; padding: 20px; border-radius: 8px; font-family: 'Consolas', 'Monaco', monospace; white-space: pre-wrap; line-height: 1.8; color: #24292e; font-size: 14px; border-left: 4px solid #667eea;">
                    @if (!string.IsNullOrEmpty(currentAgentOutput))
                    {
                        @currentAgentOutput
                    }
                    else
                    {
                        <text>â³ æ­£åœ¨ç­‰å¾… Agent å“åº”...</text>
                    }
                </div>
                
                <Timeline Style="margin-top: 20px;">
                    <TimelineItem Color="@(currentStep >= 0 ? "green" : "gray")">
                        <Icon Type="file-search" /> èµ„æ–™æ”¶é›†é˜¶æ®µ @(currentStep > 0 ? "âœ“" : "â—")
                        @if (currentStep == 0)
                        {
                            <Tag Color="@("blue")" Style="margin-left: 10px;">è¿›è¡Œä¸­</Tag>
                        }
                    </TimelineItem>
                    <TimelineItem Color="@(currentStep >= 1 ? "green" : currentStep == 0 ? "blue" : "gray")">
                        <Icon Type="edit" /> åšå®¢æ’°å†™é˜¶æ®µ @(currentStep > 1 ? "âœ“" : currentStep == 1 ? "â—" : "")
                        @if (currentStep == 1)
                        {
                            <Tag Color="@("blue")" Style="margin-left: 10px;">è¿›è¡Œä¸­</Tag>
                        }
                    </TimelineItem>
                    <TimelineItem Color="@(currentStep >= 2 ? "green" : currentStep == 1 ? "blue" : "gray")">
                        <Icon Type="audit" /> è´¨é‡å®¡æŸ¥é˜¶æ®µ @(currentStep > 2 ? "âœ“" : currentStep == 2 ? "â—" : "")
                        @if (currentStep == 2)
                        {
                            <Tag Color="@("blue")" Style="margin-left: 10px;">è¿›è¡Œä¸­</Tag>
                        }
                    </TimelineItem>
                    @if (workflowVersion == "V2")
                    {
                        <TimelineItem Color="@(currentStep >= 3 ? "green" : currentStep == 2 ? "blue" : "gray")">
                            <Icon Type="sync" /> æ™ºèƒ½é‡å†™é˜¶æ®µ @(currentStep > 3 ? "âœ“" : currentStep == 3 ? "â—" : "")
                            @if (currentStep == 3)
                            {
                                <Tag Color="@("blue")" Style="margin-left: 10px;">è¿›è¡Œä¸­</Tag>
                            }
                            @if (rewriteCount > 0)
                            {
                                <Tag Color="@("orange")" Style="margin-left: 10px;">é‡å†™æ¬¡æ•°: @rewriteCount</Tag>
                            }
                        </TimelineItem>
                        <TimelineItem Color="@(currentStep >= 4 ? "green" : "gray")">
                            <Icon Type="check-circle" /> å®Œæˆ @(currentStep >= 4 ? "âœ“" : "")
                        </TimelineItem>
                    }
                    else
                    {
                        <TimelineItem Color="@(currentStep >= 3 ? "green" : "gray")">
                            <Icon Type="check-circle" /> å®Œæˆ @(currentStep >= 3 ? "âœ“" : "")
                        </TimelineItem>
                    }
                </Timeline>

                @if (workflowVersion == "V2" && !string.IsNullOrEmpty(executorLog))
                {
                    <Divider Plain>å·¥ä½œæµæ‰§è¡Œæ—¥å¿—</Divider>
                    <div style="background: #1e1e1e; padding: 16px; border-radius: 8px; color: #d4d4d4; font-family: 'Consolas', 'Monaco', monospace; font-size: 12px; line-height: 1.6; max-height: 200px; overflow-y: auto; white-space: pre-wrap;">
                        @executorLog
                    </div>
                }
            </Card>
        </div>
    }
    else if (workflowCompleted)
    {
        <Result Status="@(workflowSuccess ? ResultStatus.Success : ResultStatus.Error)"
                Title="@(workflowSuccess ? "ğŸ‰ åšå®¢ç”Ÿæˆå·¥ä½œæµæ‰§è¡ŒæˆåŠŸ!" : "âŒ å·¥ä½œæµæ‰§è¡Œå¤±è´¥")"
                SubTitle="@resultMessage">
            <Extra>
                @if (workflowSuccess)
                {
                    <Space>
                        <SpaceItem>
                            <Button Type="@ButtonType.Primary" OnClick="@(() => Navigation.NavigateTo($"/blog/detail/{TaskId}"))">
                                <Icon Type="eye" /> æŸ¥çœ‹åšå®¢è¯¦æƒ…
                            </Button>
                        </SpaceItem>
                        <SpaceItem>
                            <Button OnClick="@(() => Navigation.NavigateTo("/blog/list"))">
                                <Icon Type="unordered-list" /> åšå®¢åˆ—è¡¨
                            </Button>
                        </SpaceItem>
                        <SpaceItem>
                            <Button OnClick="@(() => Navigation.NavigateTo("/blog/create"))">
                                <Icon Type="plus" /> åˆ›å»ºæ–°åšå®¢
                            </Button>
                        </SpaceItem>
                    </Space>
                }
                else
                {
                    <Space>
                        <SpaceItem>
                            <Button Type="@ButtonType.Primary" OnClick="@StartWorkflow">
                                <Icon Type="redo" /> é‡æ–°æ‰§è¡Œ
                            </Button>
                        </SpaceItem>
                        <SpaceItem>
                            <Button OnClick="@(() => Navigation.NavigateTo($"/blog/workflow/{TaskId}"))">
                                <Icon Type="edit" /> åˆ†æ­¥è°ƒè¯•
                            </Button>
                        </SpaceItem>
                    </Space>
                }
            </Extra>
        </Result>

        @if (workflowSuccess && reviewResult != null)
        {
            <Divider />
            
            <Descriptions Title="è´¨é‡è¯„ä¼°æŠ¥å‘Š" Bordered Column="2" Style="margin-top:20px;">
                <DescriptionsItem Title="ç»¼åˆè¯„åˆ†" Span="2">
                    <Progress Percent="@reviewResult.OverallScore"
                              Status="@(reviewResult.OverallScore >= 80 ? ProgressStatus.Success : reviewResult.OverallScore >= 60 ? ProgressStatus.Normal : ProgressStatus.Exception)"
                              StrokeWidth="20" />
                </DescriptionsItem>
                <DescriptionsItem Title="å‡†ç¡®æ€§">
                    <Tag Color="@(reviewResult.Accuracy.Score >= 32 ? "success" : "warning")">@reviewResult.Accuracy.Score / 40</Tag>
                </DescriptionsItem>
                <DescriptionsItem Title="é€»è¾‘æ€§">
                    <Tag Color="@(reviewResult.Logic.Score >= 24 ? "success" : "warning")">@reviewResult.Logic.Score / 30</Tag>
                </DescriptionsItem>
                <DescriptionsItem Title="åŸåˆ›æ€§">
                    <Tag Color="@(reviewResult.Originality.Score >= 16 ? "success" : "warning")">@reviewResult.Originality.Score / 20</Tag>
                </DescriptionsItem>
                <DescriptionsItem Title="è§„èŒƒæ€§">
                    <Tag Color="@(reviewResult.Formatting.Score >= 8 ? "success" : "warning")">@reviewResult.Formatting.Score / 10</Tag>
                </DescriptionsItem>
                <DescriptionsItem Title="å®¡æŸ¥å»ºè®®" Span="2">
                    <Tag Color="@(reviewResult.Recommendation == "é€šè¿‡" ? "success" : reviewResult.Recommendation == "éœ€ä¿®æ”¹" ? "warning" : "error")" Style="font-size:16px; padding:5px 15px;">
                        @reviewResult.Recommendation
                    </Tag>
                </DescriptionsItem>
            </Descriptions>
        }
    }
</Card>

@code {
    [Parameter] public int TaskId { get; set; }

    private string workflowVersion = "V2"; // é»˜è®¤ä½¿ç”¨ V2 æ¡ä»¶å·¥ä½œæµ
    private int currentStep = 0;
    private StepsStatus stepStatus = StepsStatus.Process;
    private string currentStageTitle = "æ™ºèƒ½åšå®¢ç”Ÿæˆå·¥ä½œæµ";

    private bool workflowStarted = false;
    private bool workflowExecuting = false;
    private bool workflowCompleted = false;
    private bool workflowSuccess = false;

    private string executionMessage = "";
    private string resultMessage = "";
    private string currentAgentOutput = "";

    private ReviewResultDto? reviewResult;
    private int rewriteCount = 0;
    private string? executorLog = "";
    private bool _disposed = false;

    private System.Threading.Timer? _progressTimer;
    private int _pollingCount = 0;

    private string GetRadioStyle(bool isFirst)
    {
        return isFirst
            ? "display: block; margin-bottom: 12px; padding: 12px; border: 1px solid #d9d9d9; border-radius: 4px; cursor: pointer;"
            : "display: block; padding: 12px; border: 1px solid #1890ff; border-radius: 4px; cursor: pointer; background-color: #e6f7ff;";
    }

    private void OnWorkflowVersionChanged(string value)
    {
        workflowVersion = value;
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        // æ£€æŸ¥å·¥ä½œæµçŠ¶æ€
        try
        {
            var state = await AgentWorkflowService.GetWorkflowStateAsync(TaskId);
            
            if (state.IsPublished || state.HasReviewResult)
            {
                workflowCompleted = true;
                workflowSuccess = true;
                currentStep = 3;
                stepStatus = StepsStatus.Finish;
                resultMessage = "å·¥ä½œæµå·²å®Œæˆ,åšå®¢ç”ŸæˆæˆåŠŸ!";
                
                if (state.HasReviewResult)
                {
                    reviewResult = await BlogService.GetReviewResultAsync(TaskId);
                }
            }
        }
        catch (Exception ex)
        {
            await InvokeAsync(() => Message.Warning($"æ— æ³•åŠ è½½å·¥ä½œæµçŠ¶æ€: {ex.Message}"));
        }
    }

    private async Task StartWorkflow()
    {
        workflowStarted = true;
        workflowExecuting = true;
        workflowCompleted = false;
        currentStep = 0;
        rewriteCount = 0;
        executionMessage = "æ­£åœ¨å¯åŠ¨å·¥ä½œæµ...";
        _pollingCount = 0;
        await SafeStateHasChangedAsync();

        try
        {
            // å¯åŠ¨è¿›åº¦è½®è¯¢ (æ¯ 1 ç§’æŸ¥è¯¢ä¸€æ¬¡ï¼Œæ›´å®æ—¶)
            _progressTimer = new System.Threading.Timer(async _ => await PollProgress(), null, 500, 1000);

            // åœ¨åå°æ‰§è¡Œå·¥ä½œæµ - æ ¹æ®ç‰ˆæœ¬é€‰æ‹©æœåŠ¡
            _ = Task.Run(async () =>
            {
                try
                {
                    var result = workflowVersion == "V2"
                        ? await AgentWorkflowServiceV2.ExecuteFullWorkflowAsync(TaskId)
                        : await AgentWorkflowService.ExecuteFullWorkflowAsync(TaskId);

                    if (!_disposed)
                    {
                        // ç­‰å¾…æœ€åä¸€æ¬¡è½®è¯¢å®Œæˆ
                        await Task.Delay(500);

                        // åœæ­¢è½®è¯¢
                        _progressTimer?.Dispose();
                        _progressTimer = null;
                    }
                }
                catch (Exception ex)
                {
                    if (!_disposed)
                    {
                        _progressTimer?.Dispose();
                        _progressTimer = null;

                        workflowSuccess = false;
                        stepStatus = StepsStatus.Error;
                        resultMessage = $"æ‰§è¡Œå¼‚å¸¸: {ex.Message}";
                        workflowExecuting = false;
                        workflowCompleted = true;

                        await InvokeAsync(() =>
                        {
                            Message.Error($"æ‰§è¡Œå¤±è´¥: {ex.Message}");
                            StateHasChanged();
                        });
                    }
                }
            });
        }
        catch (Exception ex)
        {
            if (!_disposed)
            {
                workflowSuccess = false;
                stepStatus = StepsStatus.Error;
                resultMessage = $"å¯åŠ¨å¤±è´¥: {ex.Message}";
                workflowExecuting = false;
                workflowCompleted = true;
                
                await InvokeAsync(() => Message.Error($"å¯åŠ¨å¤±è´¥: {ex.Message}"));
                await SafeStateHasChangedAsync();
            }
        }
    }

    private async Task PollProgress()
    {
        if (_disposed || !workflowExecuting) return;

        try
        {
            _pollingCount++;

            // æ ¹æ®å·¥ä½œæµç‰ˆæœ¬è·å–è¿›åº¦
            var progress = workflowVersion == "V2"
                ? AgentWorkflowServiceV2.GetWorkflowProgress(TaskId)
                : AgentWorkflowService.GetWorkflowProgress(TaskId);

            // è°ƒè¯•ä¿¡æ¯
            Console.WriteLine($"[PollProgress] è½®è¯¢æ¬¡æ•°: {_pollingCount}, è¿›åº¦å¯¹è±¡: {(progress != null ? "å­˜åœ¨" : "null")}");

            if (progress != null)
            {
                Console.WriteLine($"[PollProgress] CurrentStep: {progress.CurrentStep}, Message: {progress.Message}, Output: {progress.CurrentOutput?.Substring(0, Math.Min(50, progress.CurrentOutput?.Length ?? 0))}");

                await InvokeAsync(() =>
                {
                    currentStep = progress.CurrentStep;
                    executionMessage = progress.Message;
                    currentAgentOutput = progress.CurrentOutput ?? "";
                    rewriteCount = progress.RewriteCount;
                    executorLog = progress.ExecutorLog ?? "";

                    Console.WriteLine($"[UIæ›´æ–°] currentStep: {currentStep}, executionMessage: {executionMessage}");

                    // æ›´æ–°æ­¥éª¤çŠ¶æ€
                    if (progress.Status == "failed")
                    {
                        stepStatus = StepsStatus.Error;
                    }
                    else if (progress.IsCompleted)
                    {
                        stepStatus = StepsStatus.Finish;
                    }
                    else
                    {
                        stepStatus = StepsStatus.Process;
                    }

                    // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                    if (progress.IsCompleted)
                    {
                        workflowExecuting = false;
                        workflowCompleted = true;
                        workflowSuccess = progress.IsSuccess;

                        if (progress.IsSuccess)
                        {
                            resultMessage = workflowVersion == "V2"
                                ? $"æ¡ä»¶å·¥ä½œæµå®Œæˆ! (é‡å†™æ¬¡æ•°: {progress.RewriteCount})"
                                : "æ‰€æœ‰é˜¶æ®µå·²å®Œæˆ,åšå®¢ç”ŸæˆæˆåŠŸ!";
                            reviewResult = progress.ReviewResult;
                            Message.Success($"ğŸ‰ åšå®¢ç”Ÿæˆå·¥ä½œæµæ‰§è¡ŒæˆåŠŸ!{(workflowVersion == "V2" && progress.RewriteCount > 0 ? $" (è‡ªåŠ¨é‡å†™ {progress.RewriteCount} æ¬¡)" : "")}");
                        }
                        else
                        {
                            resultMessage = $"å·¥ä½œæµæ‰§è¡Œå¤±è´¥: {progress.ErrorMessage}";
                            Message.Error($"å·¥ä½œæµæ‰§è¡Œå¤±è´¥: {progress.ErrorMessage}");
                        }

                        // åœæ­¢è½®è¯¢
                        _progressTimer?.Dispose();
                        _progressTimer = null;
                    }

                    StateHasChanged();
                });
            }
            else
            {
                Console.WriteLine($"[PollProgress] è¿›åº¦å¯¹è±¡ä¸º null, è½®è¯¢æ¬¡æ•°: {_pollingCount}");

                if (_pollingCount > 300) // 5åˆ†é’Ÿè¶…æ—¶ (300 * 1ç§’)
                {
                    await InvokeAsync(() =>
                    {
                        workflowExecuting = false;
                        workflowCompleted = true;
                        workflowSuccess = false;
                        resultMessage = "å·¥ä½œæµæ‰§è¡Œè¶…æ—¶";
                        stepStatus = StepsStatus.Error;

                        _progressTimer?.Dispose();
                        _progressTimer = null;

                        Message.Error("å·¥ä½œæµæ‰§è¡Œè¶…æ—¶");
                        StateHasChanged();
                    });
                }
            }
        }
        catch (Exception ex)
        {
            // è½®è¯¢å‡ºé”™ä¸ä¸­æ–­æ•´ä¸ªæµç¨‹
            Console.WriteLine($"è½®è¯¢è¿›åº¦å‡ºé”™: {ex.Message}");
        }
    }

    private async Task SafeStateHasChangedAsync()
    {
        if (!_disposed)
        {
            try
            {
                await InvokeAsync(StateHasChanged);
            }
            catch (ObjectDisposedException)
            {
                // ç»„ä»¶å·²è¢«é”€æ¯,å¿½ç•¥
            }
        }
    }

    private string GetCurrentAgentIcon()
    {
        return currentStep switch
        {
            0 => "ğŸ” ResearcherAgent",
            1 => "âœï¸ WriterAgent",
            2 => "ğŸ” ReviewerAgent",
            _ => "âœ…"
        };
    }

    public void Dispose()
    {
        _disposed = true;
        _progressTimer?.Dispose();
        _progressTimer = null;
    }
}
